<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Keine Gnade f√ºr die Wade - Runcalender</title>
  <meta name="description" content="A small run calendar with signups stored in Google Sheets." />

  <style>
    :root{
      --bg: #0b1020;
      --card: rgba(255,255,255,.08);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.68);
      --muted2: rgba(255,255,255,.52);
      --border: rgba(255,255,255,.12);
      --shadow: 0 20px 60px rgba(0,0,0,.35);
      --radius: 18px;

      --accent1: #7c3aed;
      --accent2: #22c55e;
      --warn: #f59e0b;
      --danger: #ef4444;
    }

    * { box-sizing: border-box; }
    body{
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color: var(--text);
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(124,58,237,.30), transparent 55%),
        radial-gradient(1000px 600px at 70% 20%, rgba(34,197,94,.22), transparent 55%),
        radial-gradient(900px 600px at 45% 85%, rgba(59,130,246,.18), transparent 55%),
        var(--bg);
      min-height: 100vh;
    }

    .wrap{
      max-width: 1100px;
      margin: 0 auto;
      padding: 28px 18px 64px;
    }

    header{
      display: flex;
      align-items: flex-end;
      justify-content: space-between;
      gap: 16px;
      padding: 18px 14px 18px;
    }

    .title{ display:flex; flex-direction: column; gap: 8px; }
    h1{
      margin: 0;
      font-size: clamp(26px, 4vw, 38px);
      letter-spacing: -.02em;
      line-height: 1.1;
    }
    .subtitle{
      margin: 0;
      color: var(--muted);
      max-width: 58ch;
      line-height: 1.45;
      font-size: 14.5px;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding: 10px 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.06);
      border-radius: 999px;
      box-shadow: 0 10px 40px rgba(0,0,0,.20);
      backdrop-filter: blur(12px);
      font-size: 13px;
      color: var(--muted);
      user-select: none;
      white-space: nowrap;
    }
    .dot{
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: linear-gradient(135deg, var(--accent1), #60a5fa);
      box-shadow: 0 0 0 4px rgba(124,58,237,.18);
    }

    /* NEW: filter bar */
    .filters{
      display:flex;
      flex-wrap: wrap;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
      padding: 0 14px 18px;
    }

    .filter-group{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items:center;
    }

    .select{
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      font-size: 13.5px;
      outline: none;
      min-width: 160px;
    }

    .select:focus{
      border-color: rgba(124,58,237,.55);
    }

    .chip{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 9px 11px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.82);
      font-size: 12.5px;
      user-select:none;
    }

    .chip strong{ color: rgba(255,255,255,.92); }

    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 16px;
    }

    .card{
      grid-column: span 12;
      border: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
      position: relative;
      backdrop-filter: blur(14px);
    }

    .card-inner{
      padding: 18px 18px 16px;
      display: grid;
      grid-template-columns: 1.2fr 1fr;
      gap: 18px;
    }

    @media (max-width: 900px){
      header{ flex-direction: column; align-items: flex-start; }
      .filters{ flex-direction: column; align-items: flex-start; }
      .card-inner{ grid-template-columns: 1fr; }
    }

    .run-head{
      display:flex;
      align-items:flex-start;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 10px;
    }
    .run-title{
      margin: 0;
      font-size: 18.5px;
      letter-spacing: -.01em;
    }
    .run-meta{
      display:flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 10px 0 0;
      color: var(--muted);
      font-size: 14px;
      line-height: 1.5;
    }

    .badges{
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items:center;
      justify-content:flex-end;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.80);
      font-size: 12.5px;
      white-space: nowrap;
    }
    .badge strong{ color: rgba(255,255,255,.92); font-weight: 650; }

    .icon{ width: 16px; height: 16px; display:inline-block; opacity: .95; }

    .cta-row{
      margin-top: 12px;
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items:center;
    }

    a.btn{
      text-decoration:none;
      display:inline-flex;
      gap: 10px;
      align-items:center;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.08);
      color: rgba(255,255,255,.90);
      font-weight: 600;
      font-size: 13.5px;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
    }
    a.btn:hover{
      transform: translateY(-1px);
      background: rgba(255,255,255,.11);
      border-color: rgba(255,255,255,.20);
    }

    .right{
      display:flex;
      flex-direction: column;
      gap: 12px;
      padding-left: 6px;
    }

    .panel{
      border: 1px solid var(--border);
      background: rgba(0,0,0,.10);
      border-radius: 16px;
      padding: 14px;
    }

    .panel h3{
      margin: 0 0 10px;
      font-size: 14px;
      letter-spacing: -.01em;
      color: rgba(255,255,255,.88);
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
    }

    .small{
      color: var(--muted2);
      font-size: 12.5px;
      line-height: 1.35;
      margin: 0;
    }

    .info-box{
      margin-top: 10px;
      padding: 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.86);
      font-size: 13.5px;
      line-height: 1.45;
      white-space: pre-wrap;
    }

    .signup{
      display:flex;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    input[type="text"], textarea{
      font-family: inherit;
    }
    input[type="text"]{
      flex: 1 1 190px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      outline: none;
    }
    input[type="text"]::placeholder{ color: rgba(255,255,255,.45); }

    textarea{
      width: 100%;
      min-height: 90px;
      resize: vertical;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      outline: none;
    }
    textarea::placeholder{ color: rgba(255,255,255,.45); }

    button{
      cursor: pointer;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.18);
      background: linear-gradient(135deg, rgba(124,58,237,.85), rgba(59,130,246,.65));
      color: white;
      font-weight: 700;
      font-size: 13.5px;
      transition: transform .12s ease, filter .12s ease;
    }
    button:hover{ transform: translateY(-1px); filter: brightness(1.05); }
    button:disabled{ opacity: .55; cursor: not-allowed; transform:none; }

    .names{
      margin: 10px 0 0;
      padding: 0;
      list-style: none;
      display:flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .names li{
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.85);
      font-size: 12.5px;
    }

    .status{
      margin-top: 8px;
      font-size: 12.5px;
      color: var(--muted);
    }
    .status.ok{ color: rgba(34,197,94,.95); }
    .status.warn{ color: rgba(245,158,11,.95); }
    .status.err{ color: rgba(239,68,68,.95); }

    .divider{
      height: 1px;
      background: rgba(255,255,255,.10);
      margin: 18px 0;
      border-radius: 999px;
    }

    footer{
      margin-top: 26px;
      color: rgba(255,255,255,.45);
      font-size: 12.5px;
      text-align: center;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="title">
        <h1>Keine Gnade f√ºr die Wade</h1>
        <p class="subtitle">Race Calender</p>
      </div>
      <div class="pill"><span class="dot"></span><span id="syncState">Connecting‚Ä¶</span></div>
    </header>

    <!-- NEW: Filter bar -->
    <div class="filters">
      <div class="filter-group">
        <span class="chip"><strong>Filter</strong></span>
        <select class="select" id="typeFilter" aria-label="Filter by run type">
          <option value="all">All types</option>
          <option value="road">Road</option>
          <option value="trail">Trail</option>
        </select>

        <select class="select" id="monthFilter" aria-label="Filter by month">
          <option value="all">All months</option>
        </select>

        <button id="resetFilters" type="button" style="background: rgba(255,255,255,.08); border-color: rgba(255,255,255,.16); font-weight:650;">
          Reset
        </button>
      </div>

      <div class="filter-group">
        <span class="chip"><span style="opacity:.9">Showing:</span> <strong id="shownCount">0</strong></span>
      </div>
    </div>

    <main class="grid" id="runs"></main>

    <!-- NEW: Suggest a run -->
    <div class="divider"></div>
    <section class="card">
      <div class="card-inner" style="grid-template-columns: 1fr;">
        <div class="panel">
          <h3>Suggest a run</h3>
          <p class="small">Have a cool race idea? Drop the link + a short note.</p>

          <div class="signup" style="margin-top:12px;">
            <input type="text" id="suggestLink" placeholder="Run website link (https://‚Ä¶)" />
          </div>
          <div style="margin-top:10px;">
            <textarea id="suggestNote" placeholder="Why this run? Distance, travel idea, deadline, etc."></textarea>
          </div>

          <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
            <button id="suggestBtn" type="button">Submit suggestion</button>
            <div class="status" id="suggestStatus"></div>
          </div>
        </div>
      </div>
    </section>

    <footer>
      This website has been created by Markus.
    </footer>
  </div>

<script>
  // ‚úÖ Put your Apps Script Web App URL here (must end with /exec)
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwO5Slrgbu-nZsoWTOcmlJvD-jewFX0QZaUkLP0QQa6EhS4ngt3VPEWzfGlpk3Anf3w/exec";

  // Run data (hardcoded "info" shown to everyone)
  const RUNS = [
    {
      id: "eisbaerenlauf-2026-01-18",
      title: "1. Eisb√§renlauf",
      type: "road",
      dateISO: "2026-01-18T10:00:00+01:00",
      location: "Vienna, Austria",
      distance: "7 km ¬∑ 14 km ¬∑ 21 km",
      cost: "‚Ç¨30",
      url: "https://www.lcc-wien.at/index.php?option=com_content&view=article&id=362:1eisbaerlauf-1812026&catid=42:lauf",
    },
    {
      id:"eisbaerenlauf-2026-02-15",
      title: "2. Eisb√§renlauf",
      type: "road",
      dateISO: "2026-02-15T10:00:00+01:00",
      location: "Vienna, Austria",
      distance: "7 km ¬∑ 14 km ¬∑ 21 km ¬∑ 28 km",
      cost: "‚Ç¨30",
      url: "https://www.lcc-wien.at/index.php?option=com_content&view=article&id=419:2eisbaerlauf-1522026&catid=42:lauf"
  	},
    {
      id:"eisbaerenlauf-2026-03-15",
      title: "3. Eisb√§renlauf",
      type: "road",
      dateISO: "2026-03-15T10:00:00+01:00",
      location: "Vienna, Austria",
      distance: "7 km ¬∑ 14 km ¬∑ 21 km ¬∑ 28 km",
      cost: "‚Ç¨30",
      url: "https://www.lcc-wien.at/index.php?option=com_content&view=article&id=420:3eisbaerlauf-1532026&catid=42:lauf"
  	},
    {
      id: "schneeberglauf-2026-05-30",
      title: "Schneeberglauf",
      type: "trail",
      dateISO: "2026-05-30T08:30:00+01:00", // placeholder time
      location: "Puchberg am Schneeberg, Austria",
      distance: "10 km (1200 hm) ¬∑ 20 km (2000 hm) ¬∑ 31 km (2100 hm)",
      cost: "‚Ç¨60",
      url: "https://schneeberg-lauf.at/"
    },
    {
      id:"leopoldilauf-2026-11-08",
      title: "Leopoldilauf",
      type: "road",
      dateISO: "2026-11-08T10:00:00+01:00",
      location: "Vienna, Austria",
      distance: "7 km ¬∑ 14 km ¬∑ 21 km",
      cost: "‚Ç¨30",
      url: "https://www.lcc-wien.at/index.php?option=com_content&view=article&id=749"
  	},
    {
    id: "buckltour-fruehlingslauf-2026-04-11",
    title: "Fr√ºhlingslauf (buckltour)",
    type: "trail",
    dateISO: "2026-04-11T15:00:00+02:00",
    location: "Payerbach, Austria",
    distance: "9.2 km (204 hm)",
    cost: "‚Ç¨17+",
    url: "https://fruehlingslauf.jts-events.com/" // event site for Fr√ºhlingslauf Payerbach  [oai_citation:1‚Ä°buckltour.at](https://buckltour.at/events/fruehlingslauf?utm_source=chatgpt.com)
  },
  {
    id: "buckltour-cold-mountain-run-2026-04-18",
    title: "Cold Mountain Run (buckltour)",
    type: "trail",
    dateISO: "2026-04-18T09:30:00+02:00",
    location: "Lichtenegg/Kaltenberg, Austria",
    distance: "8.5 km (298 hm)",
    cost: "‚Ç¨17+",
    url: "https://buckltour.at/events/cold-mountain-run" // official event page  [oai_citation:2‚Ä°buckltour.at](https://buckltour.at/events/cold-mountain-run?utm_source=chatgpt.com)
  },
  {
    id: "buckltour-geschriebenstein-hillclimb-2026-04-26",
    title: "Geschriebenstein Hillclimb (buckltour)",
    type: "trail",
    dateISO: "2026-04-26T11:00:00+02:00",
    location: "Rattersdorf/Liebening, Austria",
    distance: "12 km (720 hm)",
    cost: "TBD",
    url: "https://buckltour.at/events/geschriebenstein" // official event page  [oai_citation:3‚Ä°buckltour.at](https://buckltour.at/info?utm_source=chatgpt.com)
  },
  {
    id: "buckltour-schlossberglauf-2026-05-09",
    title: "Schlossberglauf (buckltour)",
    type: "trail",
    dateISO: "2026-05-09T10:00:00+02:00",
    location: "Seebenstein, Austria",
    distance: "7.8 km (421 hm)",
    cost: "TBD",
    url: "https://buckltour.at/events/schlossberglauf" // official event page  [oai_citation:4‚Ä°buckltour.at](https://buckltour.at/events/schlossberglauf?utm_source=chatgpt.com)
  },
  {
    id: "buckltour-wein-berg-lauf-2026-05-30",
    title: "Wein-Berg-Lauf (buckltour)",
    type: "trail",
    dateISO: "2026-05-30T11:00:00+02:00",
    location: "Neckenmarkt, Austria",
    distance: "10 km (300 hm)",
    cost: "TBD",
    url: "https://buckltour.at/events/wein-berg-lauf" // official event page  [oai_citation:5‚Ä°buckltour.at](https://buckltour.at/events/wein-berg-lauf?utm_source=chatgpt.com)
  },
  {
    id: "buckltour-gfieder-gelaendelauf-2026-06-13",
    title: "Gfieder Gel√§ndelauf (buckltour)",
    type: "trail",
    dateISO: "2026-06-13T10:00:00+02:00",
    location: "St. Johann bei Ternitz, Austria",
    distance: "8.5 km (250 hm)",
    cost: "TBD",
    url: "https://buckltour.at/events/gfieder-gelaendelauf" // official event page available  [oai_citation:6‚Ä°buckltour.at](https://buckltour.at/events/gfieder-gelaendelauf?utm_source=chatgpt.com)
  },
  {
    id: "buckltour-alpkogellauf-2026-06-27",
    title: "Alpkogellauf (buckltour)",
    type: "trail",
    dateISO: "2026-06-27T09:00:00+02:00",
    location: "Trattenbach, Austria",
    distance: "7.8 km (300 hm)",
    cost: "TBD",
    url: "https://buckltour.at/events/alpkogellauf" // official event page  [oai_citation:7‚Ä°buckltour.at](https://buckltour.at/)
  },
  {
    id: "buckltour-hutwisch-berglauf-2026-07-04",
    title: "Hutwisch Berglauf (buckltour)",
    type: "trail",
    dateISO: "2026-07-04T09:00:00+02:00",
    location: "Bad Sch√∂nau, Austria",
    distance: "5.5 km (430 hm)",
    cost: "TBD",
    url: "https://buckltour.at/events/hutwischberglauf" // official event page  [oai_citation:8‚Ä°buckltour.at](https://buckltour.at/events/hutwischberglauf?utm_source=chatgpt.com)
  },
  {
    id: "buckltour-wechsellandlauf-2026-07-18",
    title: "Wechsellandlauf (buckltour)",
    type: "trail",
    dateISO: "2026-07-18T09:00:00+02:00",
    location: "Aspang, Austria",
    distance: "8 km (230 hm)",
    cost: "TBD",
    url: "https://buckltour.at/events/wechsellandlauf" // official event page  [oai_citation:9‚Ä°buckltour.at](https://buckltour.at/)
  },
  {
    id: "buckltour-run-the-bugles-2026-08-30",
    title: "Run the Bugles (buckltour)",
    type: "trail",
    dateISO: "2026-08-30T09:30:00+02:00",
    location: "Krumbach, Austria",
    distance: "15 km (600 hm)",
    cost: "‚Ç¨25+",
    url: "https://buckltour.at/events/run-the-bugles" // official event page  [oai_citation:10‚Ä°buckltour.at](https://buckltour.at/events/run-the-bugles?utm_source=chatgpt.com)
  },
  {
    id: "buckltour-kampstein-berglauf-2026-09-12",
    title: "Kampstein Berglauf (buckltour)",
    type: "trail",
    dateISO: "2026-09-12T14:00:00+02:00",
    location: "St. Corona, Austria",
    distance: "6.6 km (670 hm)",
    cost: "TBD",
    url: "https://buckltour.at/events/wexl-kampsteinlauf" // official event page  [oai_citation:11‚Ä°buckltour.at](https://buckltour.at/events/wexl-kampsteinlauf?utm_source=chatgpt.com)
  },
  {
    id: "buckltour-run-the-klamm-2026-09-20",
    title: "Run the Klamm (buckltour)",
    type: "trail",
    dateISO: "2026-09-20T13:00:00+02:00",
    location: "W√ºrflach, Austria",
    distance: "10 km (350 hm)",
    cost: "‚Ç¨25+",
    url: "https://buckltour.at/events/run-the-klamm" // official event page  [oai_citation:12‚Ä°buckltour.at](https://buckltour.at/events/run-the-klamm?utm_source=chatgpt.com)
  },
  {
    id: "vienna-trail-run-2026-10-18",
    title: "Vienna Trail Run",
    type: "trail",
    dateISO: "2026-10-18T09:00:00+02:00",
    location: "Vienna / Wienerwald, Austria",
    distance: "7.5 km (300 hm) ¬∑ 16 km (550 hm) ¬∑ 24.7 km (1000 hm)",
    cost: "TBD",
    url: "https://viennatrailrun.at/" // official event site ([viennatrailrun.at](https://viennatrailrun.at/?utm_source=chatgpt.com))
  },
  {
    id: "innsbruck-alpine-trailrun-festival-2026-04-29",
    title: "Innsbruck Alpine Trailrun Festival (IATF)",
    type: "trail",
    dateISO: "2026-04-29T08:00:00+02:00",
    location: "Innsbruck, Tyrol, Austria",
    distance: "7.3 km (250 hm) ¬∑ 17.3 km (520 hm) ¬∑ 26.2 km (870 hm) ¬∑ 37.8 km (2110 hm) ¬∑ 42.3 km (2500 hm) ¬∑ 63.9 km (2450 hm) ¬∑ 86.7 km (3880 hm) ¬∑ 108.3 km (5600 hm)",
    cost: "TBD",
    url: "https://innsbruckalpine.laufwerkstatt.at/" // official event site ([innsbruckalpine.at](https://innsbruckalpine.laufwerkstatt.at/?lang=en&utm_source=chatgpt.com))  [oai_citation:0‚Ä°Innsbruck Alpine](https://innsbruckalpine.at/strecke/?utm_source=chatgpt.com)
  },
  {
    id: "wachau-trail-2026-10-03",
    title: "Wachau Trail",
    type: "trail",
    dateISO: "2026-10-03T06:00:00+02:00",
    location: "Wachau / Krems an der Donau, Austria",
    distance: "10.2 km (355 hm) ¬∑ 24.2 km (1007 hm) ¬∑ 34.8 km (1397 hm) ¬∑ 56.7 km (2526 hm) ¬∑ 77 km (3191 hm) ¬∑ 101 km (3886 hm) ¬∑ 160 km (5900 hm)",
    cost: "TBD",
    url: "https://www.wachautrail.at/" // official event site ([wachautrail.at](https://www.wachautrail.at/?utm_source=chatgpt.com))  [oai_citation:1‚Ä°Wachau Trail](https://www.wachautrail.at/?utm_source=chatgpt.com)
  },
  {
    id: "vienna-city-marathon-2026-04-19",
    title: "Vienna City Marathon",
    type: "road",
    dateISO: "2026-04-19T09:00:00+02:00",
    location: "Vienna, Austria",
    distance: "42.195 km ¬∑ 21.0975 km ¬∑ 10 km ¬∑ 5 km",
    cost: "TBD",
    url: "https://www.vienna-marathon.com/" // official event site ([vienna-marathon.com](https://www.vienna-marathon.com/?go=welcome&lang=en&utm_source=chatgpt.com))
  }
  ];

  const icons = {
    road: `<svg class="icon" viewBox="0 0 24 24" fill="none">
      <path d="M9 2h6l1 20h-3l-.5-5h-1L11 22H8L9 2Z" stroke="currentColor" stroke-width="1.6"/>
      <path d="M12 6v3M12 12v3" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
    </svg>`,
    trail: `<svg class="icon" viewBox="0 0 24 24" fill="none">
      <path d="M3 19l7-8 5 6 3-4 3 6H3Z" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"/>
      <path d="M7 8a2 2 0 1 0 0-.01Z" stroke="currentColor" stroke-width="1.6"/>
    </svg>`,
    link: `<svg class="icon" viewBox="0 0 24 24" fill="none">
      <path d="M10 13a5 5 0 0 1 0-7l1-1a5 5 0 0 1 7 7l-1 1" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
      <path d="M14 11a5 5 0 0 1 0 7l-1 1a5 5 0 1 1-7-7l1-1" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
    </svg>`
  };

  const elRuns = document.getElementById("runs");
  const elSync = document.getElementById("syncState");

  const elTypeFilter = document.getElementById("typeFilter");
  const elMonthFilter = document.getElementById("monthFilter");
  const elResetFilters = document.getElementById("resetFilters");
  const elShownCount = document.getElementById("shownCount");

  const elSuggestLink = document.getElementById("suggestLink");
  const elSuggestNote = document.getElementById("suggestNote");
  const elSuggestBtn = document.getElementById("suggestBtn");
  const elSuggestStatus = document.getElementById("suggestStatus");

  function fmtDateTime(iso){
    const d = new Date(iso);
    const opts = { weekday:"short", year:"numeric", month:"short", day:"numeric", hour:"2-digit", minute:"2-digit" };
    return new Intl.DateTimeFormat(undefined, opts).format(d);
  }

  function escapeHtml(str){
    return String(str).replace(/[&<>"']/g, s => ({
      "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#039;"
    }[s]));
  }

  function monthKey(iso){
    const d = new Date(iso);
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    return `${y}-${m}`; // e.g. 2026-01
  }

  function monthLabel(key){
    const [y, m] = key.split("-").map(Number);
    const d = new Date(y, m - 1, 1);
    return new Intl.DateTimeFormat(undefined, { month:"long", year:"numeric" }).format(d);
  }

  function populateMonthFilter(){
    const keys = Array.from(new Set(RUNS.map(r => monthKey(r.dateISO)))).sort();
    for (const k of keys){
      const opt = document.createElement("option");
      opt.value = k;
      opt.textContent = monthLabel(k);
      elMonthFilter.appendChild(opt);
    }
  }

  function getFilteredRuns(){
    const type = elTypeFilter.value;
    const month = elMonthFilter.value;

    return RUNS.filter(r => {
      const typeOk = (type === "all") || (r.type === type);
      const monthOk = (month === "all") || (monthKey(r.dateISO) === month);
      return typeOk && monthOk;
    }).sort((a,b)=> new Date(a.dateISO) - new Date(b.dateISO));
  }

  function render(){
    const filtered = getFilteredRuns();
    elShownCount.textContent = String(filtered.length);

    elRuns.innerHTML = filtered.map(run => `
      <section class="card" data-runid="${run.id}">
        <div class="card-inner">
          <div class="left">
            <div class="run-head">
              <div>
                <h2 class="run-title">${run.title}</h2>
                <div class="run-meta">
                  <span>üóìÔ∏è ${fmtDateTime(run.dateISO)}</span>
                  <span>üìç ${run.location}</span>
                  <span>üìè ${run.distance}</span>
                  <span>üí∂ ${run.cost}</span>
                </div>

                <div class="cta-row">
                  <a class="btn" href="${run.url}" target="_blank" rel="noopener noreferrer">
                    ${icons.link} Visit run website
                  </a>
                </div>
              </div>

              <div class="badges">
                <span class="badge" title="${run.type === 'trail' ? 'Trail run' : 'Road run'}">
                  ${run.type === "trail" ? icons.trail : icons.road}
                  <strong>${run.type.toUpperCase()}</strong>
                </span>
              </div>
            </div>

            ${run.info ? `
              <div class="panel">
                <h3>Info</h3>
                <p class="small">Notes from Markus</p>
                <div class="info-box">${escapeHtml(run.info)}</div>
              </div>
            ` : ``}
          </div>

          <div class="right">
            <div class="panel">
              <h3>
                Attendance
                <span class="small" data-count>loading‚Ä¶</span>
              </h3>

              <p class="small">
              
              </p>

              <div class="signup">
                <input type="text" maxlength="60" placeholder="Your name" data-name />
                <button data-submit>Sign up</button>
              </div>
              <div class="status" data-status></div>

              <ul class="names" data-names></ul>
            </div>
          </div>
        </div>
      </section>
    `).join("");

    for (const run of filtered){
      const card = elRuns.querySelector(`.card[data-runid="${run.id}"]`);
      const btn = card.querySelector("[data-submit]");
      btn.addEventListener("click", () => signup(run.id, run.title));
    }
  }

  // ---------- JSONP (for cross-origin GET without CORS) ----------
  function jsonp(url) {
    return new Promise((resolve, reject) => {
      const cb = "cb_" + Math.random().toString(36).slice(2);
      const s = document.createElement("script");
      const timeout = setTimeout(() => {
        cleanup();
        reject(new Error("JSONP timeout"));
      }, 8000);

      function cleanup() {
        clearTimeout(timeout);
        try { delete window[cb]; } catch {}
        s.remove();
      }

      window[cb] = (data) => {
        cleanup();
        resolve(data);
      };

      s.src = url + (url.includes("?") ? "&" : "?") + "callback=" + cb + "&t=" + Date.now();
      s.onerror = () => {
        cleanup();
        reject(new Error("JSONP load error"));
      };

      document.head.appendChild(s);
    });
  }

  async function refreshSignups(){
    const data = await jsonp(SCRIPT_URL);   // requires Apps Script doGet to support ?callback=
    if (!data || !data.ok) throw new Error((data && data.error) || "Failed to load signups");

    const grouped = data.grouped || {};

    // Update only cards currently on screen (filtered)
    const visible = getFilteredRuns();

    for (const run of visible){
      const list = (grouped[run.id] || []).map(x => x.name).filter(Boolean);

      const uniq = [];
      const seen = new Set();
      for (const n of list){
        const key = n.trim().toLowerCase();
        if (!key || seen.has(key)) continue;
        seen.add(key);
        uniq.push(n.trim());
      }

      setCount(run.id, uniq.length);
      setNames(run.id, uniq);
    }
  }

  // ---------- POST signup (try normal; fallback to no-cors) ----------
  async function apiPostSignup(runId, runTitle, name){
    const body = new URLSearchParams({ runId, runTitle, name });

    const res = await fetch(SCRIPT_URL, { method: "POST", body });
    const data = await res.json();
    if (!data.ok) throw new Error(data.error || "Failed to sign up");
    return data;
  }

  function setStatus(runId, kind, msg){
    const card = elRuns.querySelector(`.card[data-runid="${runId}"]`);
    if (!card) return;
    const s = card.querySelector("[data-status]");
    s.className = "status " + (kind || "");
    s.textContent = msg || "";
  }

  function setCount(runId, n){
    const card = elRuns.querySelector(`.card[data-runid="${runId}"]`);
    if (!card) return;
    const c = card.querySelector("[data-count]");
    c.textContent = `${n} signed up`;
  }

  function setNames(runId, names){
    const card = elRuns.querySelector(`.card[data-runid="${runId}"]`);
    if (!card) return;
    const ul = card.querySelector("[data-names]");
    ul.innerHTML = (names && names.length)
      ? names.map(x => `<li>${escapeHtml(x)}</li>`).join("")
      : `<li style="opacity:.7">No one yet ü•∫</li>`;
  }

  async function signup(runId, runTitle){
    const card = elRuns.querySelector(`.card[data-runid="${runId}"]`);
    const input = card.querySelector("[data-name]");
    const btn = card.querySelector("[data-submit]");
    const name = (input.value || "").trim();

    if (!name){
      setStatus(runId, "warn", "Please enter your name.");
      return;
    }

    btn.disabled = true;
    setStatus(runId, "", "Submitting‚Ä¶");

    try{
      const resp = await apiPostSignup(runId, runTitle, name);

      if (resp.duplicate){
        setStatus(runId, "warn", "You‚Äôre already on the list.");
      } else {
        setStatus(runId, "ok", "Signed up! üéâ");
        input.value = "";
      }

      await refreshSignups();

    } catch(err){
      // Fallback: submit without CORS (cannot read response)
      try{
        await fetch(SCRIPT_URL, {
          method: "POST",
          mode: "no-cors",
          body: new URLSearchParams({ runId, runTitle, name })
        });

        setStatus(runId, "ok", "Signed up! (refreshing‚Ä¶)");
        input.value = "";
        setTimeout(() => refreshSignups().catch(()=>{}), 1000);

      } catch(err2){
        setStatus(runId, "err", "Error: " + (err2.message || err.message || String(err2)));
      }
    } finally {
      btn.disabled = false;
    }
  }

  // ---------- Suggest a run (stores in a different sheet tab) ----------
  function setSuggestStatus(kind, msg){
    elSuggestStatus.className = "status " + (kind || "");
    elSuggestStatus.textContent = msg || "";
  }

  async function submitSuggestion(){
    const link = (elSuggestLink.value || "").trim();
    const note = (elSuggestNote.value || "").trim();

    if (!link || !/^https?:\/\/\S+/i.test(link)){
      setSuggestStatus("warn", "Please paste a valid link starting with http(s)://");
      return;
    }

    elSuggestBtn.disabled = true;
    setSuggestStatus("", "Submitting‚Ä¶");

    // We use the same Web App endpoint, but pass an "action" so the script knows
    const body = new URLSearchParams({
      action: "suggest",
      link,
      note
    });

    // Using no-cors is safest across GitHub Pages; we can‚Äôt read response, so we show a generic success.
    try{
      await fetch(SCRIPT_URL, { method: "POST", mode: "no-cors", body });
      setSuggestStatus("ok", "Suggestion submitted ‚Äî thanks! üôå");
      elSuggestLink.value = "";
      elSuggestNote.value = "";
    } catch(e){
      setSuggestStatus("err", "Error: Failed to submit suggestion.");
    } finally {
      elSuggestBtn.disabled = false;
    }
  }

  // ---------- Init ----------
  async function init(){
    populateMonthFilter();
    render();

    // filters
    elTypeFilter.addEventListener("change", async () => {
      render();
      await refreshSignups().catch(()=>{});
    });
    elMonthFilter.addEventListener("change", async () => {
      render();
      await refreshSignups().catch(()=>{});
    });
    elResetFilters.addEventListener("click", async () => {
      elTypeFilter.value = "all";
      elMonthFilter.value = "all";
      render();
      await refreshSignups().catch(()=>{});
    });

    // suggestions
    elSuggestBtn.addEventListener("click", submitSuggestion);

    if (!SCRIPT_URL || SCRIPT_URL.includes("PASTE_YOUR_SCRIPT_URL_HERE")) {
      elSync.textContent = "Backend not configured";
      return;
    }

    try{
      elSync.textContent = "Syncing‚Ä¶";
      await refreshSignups();
      elSync.textContent = "Live (Google Sheets)";
    } catch (e){
      elSync.textContent = "Backend not reachable";
      if (RUNS[0]) setStatus(RUNS[0].id, "err",
        "Backend error. IMPORTANT: your Apps Script doGet must support JSONP (?callback=...).");
    }

    setInterval(() => refreshSignups().catch(()=>{}), 30000);
  }

  init();
</script>
</body>
</html>
