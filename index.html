<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Runs I Want To Do</title>
  <meta name="description" content="A small run calendar with signups stored in Google Sheets." />

  <style>
    :root{
      --bg: #0b1020;
      --card: rgba(255,255,255,.08);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.68);
      --muted2: rgba(255,255,255,.52);
      --border: rgba(255,255,255,.12);
      --shadow: 0 20px 60px rgba(0,0,0,.35);
      --radius: 18px;

      --accent1: #7c3aed;
      --accent2: #22c55e;
      --warn: #f59e0b;
      --danger: #ef4444;
    }

    * { box-sizing: border-box; }
    body{
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color: var(--text);
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(124,58,237,.30), transparent 55%),
        radial-gradient(1000px 600px at 70% 20%, rgba(34,197,94,.22), transparent 55%),
        radial-gradient(900px 600px at 45% 85%, rgba(59,130,246,.18), transparent 55%),
        var(--bg);
      min-height: 100vh;
    }

    .wrap{
      max-width: 1100px;
      margin: 0 auto;
      padding: 28px 18px 64px;
    }

    header{
      display: flex;
      align-items: flex-end;
      justify-content: space-between;
      gap: 16px;
      padding: 18px 14px 26px;
    }

    .title{ display:flex; flex-direction: column; gap: 8px; }
    h1{
      margin: 0;
      font-size: clamp(26px, 4vw, 38px);
      letter-spacing: -.02em;
      line-height: 1.1;
    }
    .subtitle{
      margin: 0;
      color: var(--muted);
      max-width: 58ch;
      line-height: 1.45;
      font-size: 14.5px;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding: 10px 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.06);
      border-radius: 999px;
      box-shadow: 0 10px 40px rgba(0,0,0,.20);
      backdrop-filter: blur(12px);
      font-size: 13px;
      color: var(--muted);
      user-select: none;
    }
    .dot{
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: linear-gradient(135deg, var(--accent1), #60a5fa);
      box-shadow: 0 0 0 4px rgba(124,58,237,.18);
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 16px;
    }

    .card{
      grid-column: span 12;
      border: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
      position: relative;
      backdrop-filter: blur(14px);
    }

    .card-inner{
      padding: 18px 18px 16px;
      display: grid;
      grid-template-columns: 1.2fr 1fr;
      gap: 18px;
    }

    @media (max-width: 900px){
      header{ flex-direction: column; align-items: flex-start; }
      .card-inner{ grid-template-columns: 1fr; }
    }

    .run-head{
      display:flex;
      align-items:flex-start;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 10px;
    }
    .run-title{
      margin: 0;
      font-size: 18.5px;
      letter-spacing: -.01em;
    }
    .run-meta{
      display:flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 10px 0 0;
      color: var(--muted);
      font-size: 14px;
      line-height: 1.5;
    }

    .badges{
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items:center;
      justify-content:flex-end;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.80);
      font-size: 12.5px;
      white-space: nowrap;
    }
    .badge strong{ color: rgba(255,255,255,.92); font-weight: 650; }

    .icon{ width: 16px; height: 16px; display:inline-block; opacity: .95; }

    .cta-row{
      margin-top: 12px;
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items:center;
    }

    a.btn{
      text-decoration:none;
      display:inline-flex;
      gap: 10px;
      align-items:center;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.08);
      color: rgba(255,255,255,.90);
      font-weight: 600;
      font-size: 13.5px;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
    }
    a.btn:hover{
      transform: translateY(-1px);
      background: rgba(255,255,255,.11);
      border-color: rgba(255,255,255,.20);
    }

    .right{
      display:flex;
      flex-direction: column;
      gap: 12px;
      padding-left: 6px;
    }

    .panel{
      border: 1px solid var(--border);
      background: rgba(0,0,0,.10);
      border-radius: 16px;
      padding: 14px;
    }

    .panel h3{
      margin: 0 0 10px;
      font-size: 14px;
      letter-spacing: -.01em;
      color: rgba(255,255,255,.88);
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
    }

    .small{
      color: var(--muted2);
      font-size: 12.5px;
      line-height: 1.35;
      margin: 0;
    }

    .info-box{
      margin-top: 10px;
      padding: 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.86);
      font-size: 13.5px;
      line-height: 1.45;
      white-space: pre-wrap;
    }

    .signup{
      display:flex;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    input[type="text"]{
      flex: 1 1 190px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      outline: none;
    }
    input[type="text"]::placeholder{ color: rgba(255,255,255,.45); }

    button{
      cursor: pointer;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.18);
      background: linear-gradient(135deg, rgba(124,58,237,.85), rgba(59,130,246,.65));
      color: white;
      font-weight: 700;
      font-size: 13.5px;
      transition: transform .12s ease, filter .12s ease;
    }
    button:hover{ transform: translateY(-1px); filter: brightness(1.05); }
    button:disabled{ opacity: .55; cursor: not-allowed; transform:none; }

    .names{
      margin: 10px 0 0;
      padding: 0;
      list-style: none;
      display:flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .names li{
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.85);
      font-size: 12.5px;
    }

    .status{
      margin-top: 8px;
      font-size: 12.5px;
      color: var(--muted);
    }
    .status.ok{ color: rgba(34,197,94,.95); }
    .status.warn{ color: rgba(245,158,11,.95); }
    .status.err{ color: rgba(239,68,68,.95); }

    footer{
      margin-top: 26px;
      color: rgba(255,255,255,.45);
      font-size: 12.5px;
      text-align: center;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="title">
        <h1>Runs I want to do</h1>
        <p class="subtitle">Platzhalter</p>
      </div>
      <div class="pill"><span class="dot"></span><span id="syncState">Connecting‚Ä¶</span></div>
    </header>

    <main class="grid" id="runs"></main>

    <footer>
      This website has been created by Markus.
    </footer>
  </div>

<script>
  // ‚úÖ Put your Apps Script Web App URL here (must end with /exec)
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzBD2mBmhhEBxEzAxLkpG9A7Jzeeml5Y6oYPUOEzrM260kZapYTmLIFpMv1YvOeHHIk/exec";

  // Run data (hardcoded "info" shown to everyone)
  const RUNS = [
    {
      id: "eisbaerenlauf-2026-01-18",
      title: "1. Eisb√§renlauf",
      type: "road",
      dateISO: "2026-01-18T10:00:00+01:00",
      location: "Vienna, Austria",
      distance: "7 km ¬∑ 14 km ¬∑ 21 km",
      cost: "‚Ç¨30",
      url: "https://www.lcc-wien.at/index.php?option=com_content&view=article&id=362:1eisbaerlauf-1812026&catid=42:lauf",
      info: "Da ist Platz f√ºr einen Gag"
    },
    {
      id: "schneeberglauf-2026-05-30",
      title: "Schneeberglauf",
      type: "trail",
      dateISO: "2026-05-30T09:00:00+02:00", // placeholder time
      location: "Puchberg am Schneeberg, Austria",
      distance: "10 km (1200 hm) ¬∑ 20 km (2000 hm) ¬∑ 31 km (2100 hm)",
      cost: "‚Ç¨60",
      url: "https://schneeberg-lauf.at/",
      info: "Da ist Platz f√ºr einen Schm√§h"
    }
  ];

  const icons = {
    road: `<svg class="icon" viewBox="0 0 24 24" fill="none">
      <path d="M9 2h6l1 20h-3l-.5-5h-1L11 22H8L9 2Z" stroke="currentColor" stroke-width="1.6"/>
      <path d="M12 6v3M12 12v3" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
    </svg>`,
    trail: `<svg class="icon" viewBox="0 0 24 24" fill="none">
      <path d="M3 19l7-8 5 6 3-4 3 6H3Z" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"/>
      <path d="M7 8a2 2 0 1 0 0-.01Z" stroke="currentColor" stroke-width="1.6"/>
    </svg>`,
    link: `<svg class="icon" viewBox="0 0 24 24" fill="none">
      <path d="M10 13a5 5 0 0 1 0-7l1-1a5 5 0 0 1 7 7l-1 1" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
      <path d="M14 11a5 5 0 0 1 0 7l-1 1a5 5 0 1 1-7-7l1-1" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
    </svg>`
  };

  const elRuns = document.getElementById("runs");
  const elSync = document.getElementById("syncState");

  function fmtDateTime(iso){
    const d = new Date(iso);
    const opts = { weekday:"short", year:"numeric", month:"short", day:"numeric", hour:"2-digit", minute:"2-digit" };
    return new Intl.DateTimeFormat(undefined, opts).format(d);
  }

  function escapeHtml(str){
    return String(str).replace(/[&<>"']/g, s => ({
      "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#039;"
    }[s]));
  }

  function render(){
    const sorted = [...RUNS].sort((a,b)=> new Date(a.dateISO) - new Date(b.dateISO));

    elRuns.innerHTML = sorted.map(run => `
      <section class="card" data-runid="${run.id}">
        <div class="card-inner">
          <div class="left">
            <div class="run-head">
              <div>
                <h2 class="run-title">${run.title}</h2>
                <div class="run-meta">
                  <span>üóìÔ∏è ${fmtDateTime(run.dateISO)}</span>
                  <span>üìç ${run.location}</span>
                  <span>üìè ${run.distance}</span>
                  <span>üí∂ ${run.cost}</span>
                </div>

                <div class="cta-row">
                  <a class="btn" href="${run.url}" target="_blank" rel="noopener noreferrer">
                    ${icons.link} Visit run website
                  </a>
                </div>
              </div>

              <div class="badges">
                <span class="badge" title="${run.type === 'trail' ? 'Trail run' : 'Road run'}">
                  ${run.type === "trail" ? icons.trail : icons.road}
                  <strong>${run.type.toUpperCase()}</strong>
                </span>
              </div>
            </div>

            ${run.info ? `
              <div class="panel">
                <h3>Info</h3>
                <p class="small">Notes from Markus</p>
                <div class="info-box">${escapeHtml(run.info)}</div>
              </div>
            ` : ``}
          </div>

          <div class="right">
            <div class="panel">
              <h3>
                Attendance
                <span class="small" data-count>loading‚Ä¶</span>
              </h3>

              <p class="small">
                Enter your name to signal you‚Äôll attend for sure. Everyone can see the list.
              </p>

              <div class="signup">
                <input type="text" maxlength="60" placeholder="Your name" data-name />
                <button data-submit>Sign up</button>
              </div>
              <div class="status" data-status></div>

              <ul class="names" data-names></ul>
            </div>
          </div>
        </div>
      </section>
    `).join("");

    for (const run of RUNS){
      const card = elRuns.querySelector(`.card[data-runid="${run.id}"]`);
      const btn = card.querySelector("[data-submit]");
      btn.addEventListener("click", () => signup(run.id, run.title));
    }
  }

  // ---------- JSONP (for cross-origin GET without CORS) ----------
  function jsonp(url) {
    return new Promise((resolve, reject) => {
      const cb = "cb_" + Math.random().toString(36).slice(2);
      const s = document.createElement("script");
      const timeout = setTimeout(() => {
        cleanup();
        reject(new Error("JSONP timeout"));
      }, 8000);

      function cleanup() {
        clearTimeout(timeout);
        try { delete window[cb]; } catch {}
        s.remove();
      }

      window[cb] = (data) => {
        cleanup();
        resolve(data);
      };

      s.src = url + (url.includes("?") ? "&" : "?") + "callback=" + cb + "&t=" + Date.now();
      s.onerror = () => {
        cleanup();
        reject(new Error("JSONP load error"));
      };

      document.head.appendChild(s);
    });
  }

  async function refreshSignups(){
    const data = await jsonp(SCRIPT_URL);   // requires Apps Script doGet to support ?callback=
    if (!data || !data.ok) throw new Error((data && data.error) || "Failed to load signups");

    const grouped = data.grouped || {};

    for (const run of RUNS){
      const list = (grouped[run.id] || []).map(x => x.name).filter(Boolean);

      const uniq = [];
      const seen = new Set();
      for (const n of list){
        const key = n.trim().toLowerCase();
        if (!key || seen.has(key)) continue;
        seen.add(key);
        uniq.push(n.trim());
      }

      setCount(run.id, uniq.length);
      setNames(run.id, uniq);
    }
  }

  // ---------- POST signup (try normal; fallback to no-cors) ----------
  async function apiPostSignup(runId, runTitle, name){
    const body = new URLSearchParams({ runId, runTitle, name });

    const res = await fetch(SCRIPT_URL, { method: "POST", body });
    // if CORS blocks reading, this may throw before json parsing
    const data = await res.json();
    if (!data.ok) throw new Error(data.error || "Failed to sign up");
    return data;
  }

  function setStatus(runId, kind, msg){
    const card = elRuns.querySelector(`.card[data-runid="${runId}"]`);
    const s = card.querySelector("[data-status]");
    s.className = "status " + (kind || "");
    s.textContent = msg || "";
  }

  function setCount(runId, n){
    const card = elRuns.querySelector(`.card[data-runid="${runId}"]`);
    const c = card.querySelector("[data-count]");
    c.textContent = `${n} signed up`;
  }

  function setNames(runId, names){
    const card = elRuns.querySelector(`.card[data-runid="${runId}"]`);
    const ul = card.querySelector("[data-names]");
    ul.innerHTML = (names && names.length)
      ? names.map(x => `<li>${escapeHtml(x)}</li>`).join("")
      : `<li style="opacity:.7">No one yet ‚Äî be the first üôÇ</li>`;
  }

  async function signup(runId, runTitle){
    const card = elRuns.querySelector(`.card[data-runid="${runId}"]`);
    const input = card.querySelector("[data-name]");
    const btn = card.querySelector("[data-submit]");
    const name = (input.value || "").trim();

    if (!name){
      setStatus(runId, "warn", "Please enter your name.");
      return;
    }

    btn.disabled = true;
    setStatus(runId, "", "Submitting‚Ä¶");

    try{
      const resp = await apiPostSignup(runId, runTitle, name);

      if (resp.duplicate){
        setStatus(runId, "warn", "You‚Äôre already on the list.");
      } else {
        setStatus(runId, "ok", "Signed up! üéâ");
        input.value = "";
      }

      await refreshSignups();

    } catch(err){
      // Fallback: submit without CORS (cannot read response)
      try{
        await fetch(SCRIPT_URL, {
          method: "POST",
          mode: "no-cors",
          body: new URLSearchParams({ runId, runTitle, name })
        });

        setStatus(runId, "ok", "Signed up! (refreshing‚Ä¶)");
        input.value = "";
        setTimeout(() => refreshSignups().catch(()=>{}), 1000);

      } catch(err2){
        setStatus(runId, "err", "Error: " + (err2.message || err.message || String(err2)));
      }
    } finally {
      btn.disabled = false;
    }
  }

  async function init(){
    render();

    if (!SCRIPT_URL || SCRIPT_URL.includes("PASTE_YOUR_SCRIPT_URL_HERE")) {
      elSync.textContent = "Backend not configured";
      return;
    }

    try{
      elSync.textContent = "Syncing‚Ä¶";
      await refreshSignups();
      elSync.textContent = "Live (Google Sheets)";
    } catch (e){
      elSync.textContent = "Backend not reachable";
      if (RUNS[0]) setStatus(RUNS[0].id, "err",
        "Backend error. IMPORTANT: your Apps Script doGet must support JSONP (?callback=...).");
    }

    setInterval(() => refreshSignups().catch(()=>{}), 30000);
  }

  init();
</script>
</body>
</html>
